name: zksync-prividium-db

services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    ports:
      - 5432:5432
    volumes:
      - postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5
    entrypoint: |
      bash -c "
      cat > /docker-entrypoint-initdb.d/init.sql << 'EOF'
      -- Create databases for the prividium project
      CREATE DATABASE prividium_api;
      -- Create databases for block explorer
      CREATE DATABASE prividium_block_explorer;
      
      -- Databases created successfully
      EOF

      exec docker-entrypoint.sh postgres
      "

  l1:
    image: ghcr.io/foundry-rs/foundry:v1.3.4
    volumes:
      - ./dev/zksyncos/zkos-l1-state.json:/zkos-l1-state.json:ro
      - l1state:/home/foundry/l1state
    entrypoint: ''
    user: 'root'
    ports:
      - '5010:5010'
    healthcheck:
      test: ['CMD-SHELL', 'cast chain-id -r http://localhost:5010']
      interval: 10s
      timeout: 5s
      retries: 5
    command: |
      bash -c "
      if [[ ! -f /home/foundry/l1state/state.json ]]; then
        cp /zkos-l1-state.json /home/foundry/l1state/state.json;
      fi
      anvil --version
      anvil --state=/home/foundry/l1state/state.json --port 5010 --host 0.0.0.0
      "

  zksyncos:
    image: ghcr.io/matter-labs/zksync-os-server:v0.12.0
    platform: linux/amd64
    ports:
      - '5050:3050'
    environment:
      GENERAL_L1_RPC_URL: 'http://l1:5010'
    user: 'root'
    working_dir: '/app'
    entrypoint: ''
    command: ['/usr/bin/tini', '--', 'zksync-os-server']
    volumes:
      - zksyncos_db:/app/db
    depends_on:
      - l1
    healthcheck:
      test: ['CMD', '/usr/bin/bash', '-c', 'exec 3<>/dev/tcp/127.0.0.1/3050']
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    ports:
      - '5080:8080'
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_RELATIVE_PATH: /
      KC_HEALTH_ENABLED: 'true'
      KC_METRICS_ENABLED: 'true'
      KC_HTTP_ENABLED: 'true'
      KC_HOSTNAME_STRICT: 'false'
      KC_HOSTNAME_STRICT_HTTPS: 'false'
      KC_HOSTNAME_URL: 'http://localhost:5080'
      KC_HOSTNAME_ADMIN_URL: 'http://localhost:5080'
    command:
      - start-dev
      - --import-realm
    volumes:
      - ./dev/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    healthcheck:
      test: ['CMD-SHELL', 'exec 3<>/dev/tcp/127.0.0.1/8080;echo -e "GET /health/ready HTTP/1.1\r\nhost: 127.0.0.1:8080\r\nConnection: close\r\n\r\n" >&3;if [ $? -eq 0 ]; then echo "Healthcheck Successful";exit 0;else echo "Healthcheck Failed";exit 1;fi;']
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  prometheus:
    image: prom/prometheus:v2.48.0
    restart: unless-stopped
    ports:
      - '9090:9090'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./dev/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:9090/-/healthy']
      interval: 10s
      timeout: 5s
      retries: 5

  grafana:
    image: grafana/grafana:10.2.0
    restart: unless-stopped
    ports:
      - '3100:3000'
    volumes:
      - grafana_data:/var/lib/grafana
      - ./dev/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3100
    depends_on:
      - prometheus
    healthcheck:
      test: ['CMD-SHELL', 'wget --quiet --tries=1 --spider http://localhost:3000/api/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5

  block-explorer-api:
    image: ghcr.io/matter-labs/block-explorer-api:latest
    platform: linux/amd64
    container_name: prividium-block-explorer-api
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    environment:
      LOG_LEVEL: verbose
      NODE_ENV: development # Force cookie to be sent over HTTP
      DATABASE_HOST: postgres
      DATABASE_NAME: prividium_block_explorer
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      DATABASE_ENABLE_SSL: 'false'

      # Network
      NETWORK_NAME: testnet

      # Prividium Integration
      PRIVIDIUM: 'true'
      PRIVIDIUM_APP_URL: http://localhost:3010
      PRIVIDIUM_PERMISSIONS_API_URL: http://host.docker.internal:8000
      PRIVIDIUM_SESSION_SECRET: QkxPQ0tfRVhQTE9SRVJfU0VTU0lPTl9TRUNSRVQ=
      PRIVIDIUM_SESSION_MAX_AGE: 86400000
      PRIVIDIUM_SESSION_SAME_SITE: strict

      # Pagination
      LIMITED_PAGINATION_MAX_ITEMS: '10000'
      API_LIMITED_PAGINATION_MAX_ITEMS: '1000'
      DISABLE_BFF_API_SCHEMA_DOCS: 'true'
    ports:
      - '3002:3000'
    depends_on:
      postgres:
        condition: service_healthy

  block-explorer-app:
    image: ghcr.io/matter-labs/block-explorer-app:latest
    platform: linux/amd64
    container_name: prividium-block-explorer-app
    volumes:
      - ./dev/block-explorer/block-explorer-config.js:/usr/share/nginx/html/config.js:ro
    ports:
      - '3010:3010'
    depends_on:
      block-explorer-api:
        condition: service_started

  block-explorer-worker:
    image: ghcr.io/matter-labs/block-explorer-worker:latest
    platform: linux/amd64
    container_name: prividium-block-explorer-worker
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    environment:
      DATABASE_HOST: postgres
      DATABASE_NAME: prividium_block_explorer
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      DATABASE_ENABLE_SSL: 'false'

      NETWORK_NAME: testnet
      BLOCKCHAIN_RPC_URL: http://zksyncos:3050
      DATA_FETCHER_URL: http://block-explorer-data-fetcher:3040

      PRIVIDIUM: 'true'
      PRIVIDIUM_PERMISSIONS_API_URL: http://host.docker.internal:8000/api

      ENABLE_TOKEN_OFFCHAIN_DATA_SAVER: 'true'
      BLOCKS_PROCESSING_BATCH_SIZE: '10'
      NUMBER_OF_BLOCKS_PER_DB_TRANSACTION: '10'
    depends_on:
      postgres:
        condition: service_healthy
      block-explorer-data-fetcher:
        condition: service_started

  block-explorer-data-fetcher:
    image: ghcr.io/matter-labs/block-explorer-data-fetcher:latest
    platform: linux/amd64
    container_name: prividium-block-explorer-data-fetcher
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    environment:
      NETWORK_NAME: testnet
      BLOCKCHAIN_RPC_URL: http://zksyncos:3050
      PRIVIDIUM: 'true'
      PRIVIDIUM_PERMISSIONS_API_URL: http://host.docker.internal:8000/api
    ports:
      - '3040:3040'

volumes:
  postgres:
  l1state:
  zksyncos_db:
  prometheus_data:
  grafana_data:
